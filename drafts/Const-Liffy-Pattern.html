


<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Web Presense Of Barry Steyn - Software Engineer, Entrepreneur">
    <meta name="author" content="Barry Steyn">
    <link rel="shortcut icon" href="theme/img/doctrina-icon.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="theme/img/apple-touch-icon-144-precomposed.png">

    <title>Doctrina - 	Const Liffy Pattern For C++
</title>

    <!-- Bootstrap Base CSS -->
    <link href="http://doctrina.org/theme/css/base.css" rel="stylesheet" type="text/css">

    <!-- Custom CSS -->
    <link href="http://doctrina.org/theme/css/main.css" rel="stylesheet">

    <!-- Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,400italic,600,800|Source+Code+Pro" rel="stylesheet">

<link rel="stylesheet" href="http://doctrina.org/theme/css/print.css" type="text/css" media="print" />
</head>

<body id="page-top">
    <!-- Top Nav Bar -->
    <nav id="navbar-top" class="navbar navbar-fixed-top navbar-offset-start " role="navigation">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand " href="/index.html#page-top">
                    <img alt="brand for doctrina" src="http://doctrina.org/theme/img/apple-touch-icon-144-precomposed.png" style="float: left; max-height:100%;" />
                    <span style="padding-left: 0.5em;">Doctrina</span>
                </a>
                
                <button type="button" class="navbar-toggle" style="" data-toggle="collapse" data-target="#navigation-menu">
<i class="fa fa-bars"></i>                </button>

            </div>

            <div class="collapse navbar-collapse navbar-right" id="navigation-menu">
                        <div>
                            <ul class="nav navbar-nav">
<li class="visible-grid-float-breakpoint"><a href="/index.html">Home</a></li>                                <li><a href="category/article.html"><span>Articles</span></a></li> 
                                <li><a href="#comments"><span>Comments</span></a></li> 
                                <li><a href="#footer"><span>Connect</span></a></li> 
                            </ul>
                        </div>
            </div>


        </div>
    </nav>
    <!-- End Top Nav Bar -->

    <!-- User Defined Sections -->
	<section class="container-fluid title">
	<div class="row">
		<div class="col-md-12">
			<h1><a href="" rel="bookmark" title="Permalink to Const Liffy Pattern For C++">	Const Liffy Pattern For C++
</a></h1>
			<span>
				<a href="http://doctrina.org/index.html#about"><img src="http://doctrina.org/theme/img/me.jpg" class="img-rounded"></img></a>
			</span>
		</div>
	</div>
</section>

<section class="content">
	<div class="container">
		<div class="row">
				<div class="col-xs-12 text-center metadata">
					<ul class="center-list">
						<li class="print text-center" style="font-size: 1.5em; margin-top: 1.0em;"><strong>Barry Steyn</strong></li>
						<li class="print text-center" style="margin-bottom: 0.5em">barry.steyn@gmail.com</li>
						<li><b>Published</b>: 04  Jun  2015</li>
					</ul>
				</div>
		</div>
		<div class="row">
				<div class="col-xs-12 col-md-1 col-md-push-10 text-center">
<div id="share">
	<div>
		<span class="toctitle">Share</span>
	</div>
	<div>
	    <a class="fa-stack fa-lg twitter" href="https://twitter.com/intent/tweet?text=Const%20Liffy%20Pattern%20For%20C%2B%2B&url=http%3A//doctrina.org/drafts/Const-Liffy-Pattern.html&via=">
	        <i class="fa fa-circle fa-stack-2x"></i>
	        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
	    </a>
	</div>
	<div>
		<a class="fa-stack fa-lg facebook" href="https://www.facebook.com/sharer/sharer.php?u=http%3A//doctrina.org/drafts/Const-Liffy-Pattern.html">
		    <i class="fa fa-circle fa-stack-2x"></i>
		    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
		</a>
	</div>
	<div>
		<a class="fa-stack fa-lg google-plus" href="https://plus.google.com/share?url=http%3A//doctrina.org/drafts/Const-Liffy-Pattern.html">
		    <i class="fa fa-circle fa-stack-2x"></i>
		    <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
		</a>
	</div>
	<div>
	    <a class="fa-stack fa-lg linkedin" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A//doctrina.org/drafts/Const-Liffy-Pattern.html&title=Const%20Liffy%20Pattern%20For%20C%2B%2B">
	        <i class="fa fa-circle fa-stack-2x"></i>
	        <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
	    </a>
	</div>
</div>				</div>				


			<div id="content" class="col-xs-12 col-sm-10 col-md-8 col-sm-offset-1 col-md-offset-2 col-md-pull-1">
	<div class="article-content">
		<h1 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link"></a></h1>
<p>Immutable state has <a href="http://www.drdobbs.com/cpp/practical-advantages-of-immutable-values/240163690">many advantages</a>. Unfortunately, C++ as a language makes is designed to easily mutate state. My colleague Vincent Lascaux shared a code snippet that tries to alleviate this problem by attempting to avoid normal variables in favor of using constants that are always initialized. I decided to name his pattern <em>const liffy</em>...</p>
<h2 id="background-knowledge">Background Knowledge<a class="headerlink" href="#background-knowledge" title="Permanent link"></a></h2>
<p><a href="http://en.wikipedia.org/wiki/C%2B%2B11">C++ standard 11</a> introduced some amazing features to C++. Two such features are:</p>
<ol>
<li>The <a href="http://en.cppreference.com/w/cpp/language/auto">auto</a> variable initializer.</li>
<li><a href="http://en.cppreference.com/w/cpp/language/lambda">Lambda functions</a>.</li>
</ol>
<h3 id="auto-variable-initializer">Auto Variable initializer<a class="headerlink" href="#auto-variable-initializer" title="Permanent link"></a></h3>
<p>The keyword <em>auto</em> can be used to declare a variable. During compilation, the compiler will replace the <em>auto</em> keyword using the rules for <a href="http://en.cppreference.com/w/cpp/language/template_argument_deduction">template argument deduction</a> thereby ensuring type safety.</p>
<p>Standard modifiers for variables (like &amp; and <em>const</em>) are valid to put before <em>auto</em>. For example, the following is perfectly legal:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">auto</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">const</span> <span class="k">auto</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">result_of_some_function</span><span class="p">();</span>
</pre></div>
</td></tr></table>

<h3 id="lambda-functions">Lambda Functions<a class="headerlink" href="#lambda-functions" title="Permanent link"></a></h3>
<p>A Lambda function is an unnamed function object capable of <em>capturing</em> variables in scope. The syntax is as follows</p>
<blockquote>
<p><code>[capture-list] (parameters) { body }</code> [ref]This is not the only syntax for lambdas in C++, there are other <a href="http://en.cppreference.com/w/cpp/language/lambda#Syntax">syntaxes</a>[/ref]</p>
</blockquote>
<p>The capture list is very important. It specifies the way that variables declared outside the lambda are available within the lambda. if a lambda function uses a capture list specified by <code>[&amp;]</code>, then all variables declared in the block where the lambda is invoked is available to the lambda <em>as a reference</em>. The <em>parameters</em> are optional (in fact, no parameters are used in the <em>const liffy</em> pattern).</p>
<p>For example, the following code uses a lambda function to <em>filter</em> out all strings that do not contain the substring <em>"world"</em>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">string</span> <span class="n">word</span> <span class="o">=</span> <span class="s">&quot;world&quot;</span><span class="p">;</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">strings</span> <span class="o">=</span> <span class="p">{</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">),</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;world&quot;</span><span class="p">),</span> <span class="n">string</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="p">)};</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">results</span><span class="p">;</span>
<span class="n">for_each</span><span class="p">(</span><span class="n">strings</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">strings</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="p">(</span><span class="n">string</span> <span class="n">test</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">!=</span> <span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>
    <span class="n">results</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h1 id="the-const-liffy-pattern">The Const Liffy Pattern<a class="headerlink" href="#the-const-liffy-pattern" title="Permanent link"></a></h1>
<p>Using lambda functions, we can initialize const variables by immediately invoking the lambda:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">const</span> <span class="k">auto</span> <span class="n">var</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="p">{</span> <span class="n">code</span> <span class="n">here</span><span class="p">...;</span> <span class="k">return</span> <span class="n">something</span><span class="p">;</span> <span class="p">}</span> <span class="p">()</span>
</pre></div>
</td></tr></table>

<p>Note the invokation operator <code>()</code> operator in the above snippet. JavaScript calls this pattern an <a href="https://en.wikipedia.org/wiki/Immediately-invoked_function_expression">immediately invoked function expression</a> commonly just called <code>iffy</code>. I therefore named the pattern above <em>const liffy</em>, with <em>liffy</em> being short for <em>lambda iffy</em>.</p>
<p>The <em>const liffy</em> pattern elegantly lets one use immutable state. Some examples should set things straight.</p>
<h2 id="reading-a-variable-protected-by-a-mutex">Reading A Variable Protected By A Mutex<a class="headerlink" href="#reading-a-variable-protected-by-a-mutex" title="Permanent link"></a></h2>
<p>Multithreaded programming requires the use of a <a href="http://en.wikipedia.org/wiki/Mutual_exclusion">mutex</a> to guard against <a href="http://en.wikipedia.org/wiki/Race_condition">race conditions</a>.</p>
<p>Here is a generic example of reading a variable that is protected by a mutex:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">Object</span><span class="o">*</span> <span class="n">instance</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">obj_mutex</span><span class="p">;</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">obj_mutex</span><span class="p">);</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">protected_variable</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>The code sample above suffers from the following:</p>
<ul>
<li>The variable <code>instance</code> starts off as being uninitialized (or in the above case, initialzed to what can be considered a bogus value: <em>nullptr</em>).</li>
<li>Type information is lost: If <code>instance</code> could be a reference instead of a pointer, <em>nullptr</em> errors would never happen.</li>
</ul>
<p>Using the <em>const liffy</em> pattern ameliorates the situation:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">instance</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">obj_mutex</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">protected_variable</span><span class="p">;</span>
<span class="p">}()</span>
</pre></div>
</td></tr></table>

<p>In the above code sample, <code>instance</code> is a constant reference that is initialized to the required value. All the issues mentioned in the first example have been solved.</p>
<h2 id="creating-short-helper-functions">Creating Short Helper Functions<a class="headerlink" href="#creating-short-helper-functions" title="Permanent link"></a></h2>
<p>Assume we have a <em>Shape</em> class that is sub-classed with different types of shapes (e.g. circle, square). Given <strong>shapes</strong>, a collection of <em>Shape</em> objects, a render function will only draw red square or blue circles. That render function could look like this:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;&amp;</span> <span class="n">shape</span> <span class="o">:</span><span class="n">Shapes</span><span class="p">)</span>
  <span class="kt">bool</span> <span class="n">shouldDraw</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">shape</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ShapeType</span>:<span class="o">:</span><span class="n">Square</span><span class="o">:</span> <span class="n">shouldDraw</span> <span class="o">=</span> <span class="n">shape</span><span class="p">.</span><span class="n">color</span><span class="p">()</span> <span class="o">==</span> <span class="n">Color</span><span class="o">::</span><span class="n">red</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ShapeType</span>:<span class="o">:</span><span class="n">Circle</span><span class="o">:</span> <span class="n">shouldDraw</span> <span class="o">=</span> <span class="n">shape</span><span class="p">.</span><span class="n">color</span><span class="p">()</span> <span class="o">==</span> <span class="n">Color</span><span class="o">::</span><span class="n">blue</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">shouldDraw</span><span class="p">)</span> <span class="n">Draw</span><span class="p">(</span><span class="n">shape</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>In the above code snippet, the variable <em>shoulddraw</em> is initialized to <code>false</code> (which becomes the default of the switch statement). The <code>false</code> value is then overwritten with the correct logic in the switch statement. But why intialize <em>shoulddraw</em> to false?</p>
<ul>
<li>At the time of intialization, it is not known what the state of <em>shoulddraw</em> should be. Setting it to <code>false</code> does not really make sense.</li>
<li>A programmer is then forces to read the proceeding four lines of the switch statement to make sense of what <em>shoulddraw</em> is. So in effect, one has to read these lines just to make sense of <em>shoulddraw</em>.</li>
</ul>
<p>Seeing as a <em>lambda</em> function is really an anonymous helper function, the <em>const liffy</em> pattern can help here as well:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;&amp;</span> <span class="n">shape</span> <span class="o">:</span><span class="n">Shapes</span><span class="p">)</span>
  <span class="k">const</span> <span class="kt">bool</span> <span class="n">shouldDraw</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">shape</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">ShapeType</span>:<span class="o">:</span><span class="n">Square</span><span class="o">:</span> <span class="k">return</span> <span class="n">shape</span><span class="p">.</span><span class="n">color</span><span class="p">()</span> <span class="o">==</span> <span class="n">Color</span><span class="o">::</span><span class="n">red</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">ShapeType</span>:<span class="o">:</span><span class="n">Circle</span><span class="o">:</span> <span class="k">return</span> <span class="n">shape</span><span class="p">.</span><span class="n">color</span><span class="p">()</span> <span class="o">==</span> <span class="n">Color</span><span class="o">::</span><span class="n">blue</span><span class="p">;</span>
      <span class="nl">default:</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">shouldDraw</span><span class="p">)</span> <span class="n">Draw</span><span class="p">(</span><span class="n">shape</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>With the const liffy pattern, <em>shoulddraw</em> becomes a constant. The code is not only cleaner by using <code>false</code> in the default of the switch statement, but it is also easier to reason about and understand.</p>
<h1 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link"></a></h1>
<p>The <em>const liffy</em> pattern is actually just the result of an anonymous block. It is done all the time in languages like <a href="http://en.wikipedia.org/wiki/Scala_%28programming_language%29">scala</a> and is inspired by the discipline of functional languages. Using it allows for immutable state with all its <a href="http://www.drdobbs.com/cpp/practical-advantages-of-immutable-values/240163690">advantages</a>. </p>

		<div class="print text-center" style="margin: 1.5em 0.5em 0.1em 0.5em; padding: 0.2em; border: 1px solid #000; page-break-inside: avoid;">
			Thank you for printing this article. Please do not forget to come back to http://doctrina.org for fresh articles.
		</div>
	</div>
			</div>
		</div>
	</div>
</section>

	<section class="content" id="comments">
		<div class="container">
			<div class="row">
				<div class="col-xs-12">
					<div class="content-border">
						<h2>Comments</h2>
        				<div class="divider-grey"></div>
						<a id="disqus" href="http://doctrina.org/drafts/Const-Liffy-Pattern.html#disqus_thread">0 Comments</a>
						<div id="disqus_thread"></div>
					</div>
			    </div>
			</div>
    	</div>
	</section>
    <!-- End Sections -->

    <!-- Connect -->
    <section id="connect" class="text-center title">
        <div class="container">
            <h1>Connect</h1>
            
            <div class="row" style="padding: 1.0em 0;">
                Found anything useful on this site? Drop me a line, I'd love to hear about it.
            </div>
            
            <div class="divider-grey"></div>
            
            <div class="row">
                <div class="col-xs-12 col-md-6 col-md-offset-3">
                    <div>
                        <a class="fa-stack fa-lg x" id="x" tabindex="0">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                        </a>
                        <a class="fa-stack fa-lg twitter" href="https://twitter.com/barrysteyn" target="_blank">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                        </a>
                        <a class="fa-stack fa-lg linkedin" href="https://www.linkedin.com/in/barrysteyn" target="_blank">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                        </a>
                        <a class="fa-stack fa-lg github" href="https://github.com/barrysteyn" target="_blank">
                            <i class="fa fa-github fa-stack-2x"></i>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div id="footer" class="row">
                <div class="col-xs-12">
                    <p>&copy; <script>document.write(new Date().getFullYear());</script> Barry Steyn. All Rights Reserved.
                </div>
            </div>
            <!-- End Footer -->
        </div>
    </section>
    <!-- End Connect -->


    <!-- JavaScript -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript">
        var scrollspies = {};
        scrollspies.body = {
            'target': '#navigation-menu'
        };

		//Do not remove navbar-offset-start class
	var navbarOffset = false;

	//Scrollspy object
    scrollspies.body = {
        'target': '.toc'
    };


	$(function() {
		$('#content div.article-content a[href^="http"]').attr('target','_blank');

		var disqus = {
			shortname: 'doctrina',
			identifier: 'http://doctrina.org/drafts/Const-Liffy-Pattern.html',
			url: 'http://doctrina.org/drafts/Const-Liffy-Pattern.html',
			developer: 0
		};

		disqus_comments(disqus);
	});
    </script>
    <script src="http://doctrina.org/theme/js/main.js"></script>
    <!-- End JavaScript -->
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-33789117-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>

</html>